# ===================================================
# Konfiguracja Nginx - Wiele Wirtualnych Hostów
# ===================================================
#
# Ten plik definiuje 3 serwery wirtualne (virtual hosts),
# z których każdy nasłuchuje na innym porcie i używa
# innego certyfikatu SSL/TLS.
#
# ===================================================

# Globalne ustawienia Nginx
user  nginx;
worker_processes  auto;
error_log  /var/log/nginx/error.log warn;
pid        /var/run/nginx.pid;

events {
    worker_connections  1024;
}

http {
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;

    # Format logów
    log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
                      '$status $body_bytes_sent "$http_referer" '
                      '"$http_user_agent" "$http_x_forwarded_for"';

    access_log  /var/log/nginx/access.log  main;

    sendfile        on;
    keepalive_timeout  65;

    # ===================================================
    # SERWER 1: Certyfikat Ważny (90 dni)
    # ===================================================
    server {
        listen 8443 ssl;
        server_name valid.test.local;

        # Ścieżki do certyfikatu i klucza prywatnego
        ssl_certificate     /etc/nginx/certs/valid/cert.pem;
        ssl_certificate_key /etc/nginx/certs/valid/key.pem;

        # Podstawowe ustawienia SSL/TLS
        ssl_protocols TLSv1.2 TLSv1.3;
        ssl_ciphers HIGH:!aNULL:!MD5;
        ssl_prefer_server_ciphers on;

        # Lokalizacja główna - serwuje stronę HTML
        location / {
            root   /usr/share/nginx/html;
            index  index.html;
            
            # Dodaj nagłówek informujący o typie certyfikatu
            add_header X-Certificate-Type "Valid (90 days)" always;
        }

        # Endpoint healthcheck
        location /health {
            access_log off;
            return 200 "OK - Valid Certificate\n";
            add_header Content-Type text/plain;
        }
    }

    # ===================================================
    # SERWER 2: Certyfikat Wygasający Wkrótce (7 dni)
    # ===================================================
    server {
        listen 8444 ssl;
        server_name expiring.test.local;

        ssl_certificate     /etc/nginx/certs/expiring/cert.pem;
        ssl_certificate_key /etc/nginx/certs/expiring/key.pem;

        ssl_protocols TLSv1.2 TLSv1.3;
        ssl_ciphers HIGH:!aNULL:!MD5;
        ssl_prefer_server_ciphers on;

        location / {
            root   /usr/share/nginx/html;
            index  index.html;
            add_header X-Certificate-Type "Expiring Soon (7 days)" always;
        }

        location /health {
            access_log off;
            return 200 "OK - Expiring Certificate\n";
            add_header Content-Type text/plain;
        }
    }

    # ===================================================
    # SERWER 3: Certyfikat Wygasły
    # ===================================================
    server {
        listen 8445 ssl;
        server_name expired.test.local;

        ssl_certificate     /etc/nginx/certs/expired/cert.pem;
        ssl_certificate_key /etc/nginx/certs/expired/key.pem;

        ssl_protocols TLSv1.2 TLSv1.3;
        ssl_ciphers HIGH:!aNULL:!MD5;
        ssl_prefer_server_ciphers on;

        location / {
            root   /usr/share/nginx/html;
            index  index.html;
            add_header X-Certificate-Type "Expired" always;
        }

        location /health {
            access_log off;
            return 200 "OK - Expired Certificate\n";
            add_header Content-Type text/plain;
        }
    }
}

# ===================================================
# WYJAŚNIENIE KONFIGURACJI
# ===================================================
#
# 1. STRUKTURA PLIKU
#    - Nginx dzieli konfigurację na bloki: http { server { location {} } }
#    - http = Kontekst globalny dla wszystkich serwerów HTTP/HTTPS
#    - server = Definicja pojedynczego wirtualnego hosta
#    - location = Reguły dla konkretnych ścieżek URL
#
# 2. GLOBALNE USTAWIENIA
#    user nginx;
#    - Nginx działa jako użytkownik "nginx" (nie root) - bezpieczeństwo
#    
#    worker_processes auto;
#    - Liczba procesów roboczych = liczba rdzeni CPU
#    
#    worker_connections 1024;
#    - Każdy proces może obsłużyć 1024 jednoczesne połączenia
#
# 3. BLOK SERVER
#    listen 8443 ssl;
#    - Nginx nasłuchuje na porcie 8443 z włączonym SSL/TLS
#    - Każdy server nasłuchuje na innym porcie (8443, 8444, 8445)
#    
#    server_name valid.test.local;
#    - Nazwa hosta (opcjonalna, bo rozróżniamy po porcie)
#    - Przydatna, gdybyśmy używali SNI (Server Name Indication)
#    
#    ssl_certificate /etc/nginx/certs/valid/cert.pem;
#    - Ścieżka do certyfikatu (klucz publiczny)
#    - Ten plik jest montowany z hosta przez docker-compose volumes
#    
#    ssl_certificate_key /etc/nginx/certs/valid/key.pem;
#    - Ścieżka do klucza prywatnego (MUSI BYĆ CHRONIONY!)
#    
#    ssl_protocols TLSv1.2 TLSv1.3;
#    - Obsługiwane wersje protokołu TLS
#    - TLSv1.0 i TLSv1.1 są przestarzałe i niebezpieczne
#    
#    ssl_ciphers HIGH:!aNULL:!MD5;
#    - Lista dozwolonych algorytmów szyfrowania
#    - HIGH = Silne szyfry (AES256, ChaCha20)
#    - !aNULL = Blokuj szyfry bez uwierzytelniania
#    - !MD5 = Blokuj szyfry używające MD5 (słabe)
#
# 4. BLOK LOCATION
#    location / { ... }
#    - Obsługuje wszystkie żądania (np. https://localhost:8443/)
#    - root = Ścieżka do plików statycznych (HTML)
#    - index = Domyślny plik (index.html)
#    
#    add_header X-Certificate-Type "Valid (90 days)" always;
#    - Dodaje niestandardowy nagłówek HTTP do odpowiedzi
#    - Przydatne do debugowania - widać, który serwer odpowiedział
#    - Sprawdź przez: curl -I -k https://localhost:8443
#    
#    location /health { ... }
#    - Endpoint do healthcheck (używany przez Docker i monitoring)
#    - Zwraca status 200 OK bez logowania do pliku access.log
#    - Testuj przez: curl -k https://localhost:8443/health
#
# 5. RÓŻNICE MIĘDZY SERWERAMI
#    - Każdy server nasłuchuje na INNYM PORCIE (8443, 8444, 8445)
#    - Każdy używa INNEGO CERTYFIKATU (valid, expiring, expired)
#    - Reszta konfiguracji jest identyczna
#
# 6. JAK TO DZIAŁA W PRAKTYCE?
#    
#    Użytkownik wykonuje:
#    python scripts/main.py
#    
#    Skrypt łączy się z:
#    - localhost:8443 → Pobiera certyfikat z /certs/valid/
#    - localhost:8444 → Pobiera certyfikat z /certs/expiring/
#    - localhost:8445 → Pobiera certyfikat z /certs/expired/
#    
#    Nginx zwraca certyfikat podczas handshake TLS
#    Skrypt sprawdza datę wygaśnięcia (notAfter)
#    Jeśli < 7 dni → Wysyła alert WARNING
#    Jeśli wygasły → Wysyła alert CRITICAL
